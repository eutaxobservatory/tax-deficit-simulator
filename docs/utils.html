<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>tax_deficit_simulator.utils API documentation</title>
<meta name="description" content="This module provides several functions useful to run the simulations defined in &#34;calculator.py&#34; or &#34;firm_level.py&#34; â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>tax_deficit_simulator.utils</code></h1>
</header>
<section id="section-intro">
<p>This module provides several functions useful to run the simulations defined in "calculator.py" or "firm_level.py".</p>
<p>It also provides various utils for the "app.py" file, especially to add file download buttons.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
This module provides several functions useful to run the simulations defined in &#34;calculator.py&#34; or &#34;firm_level.py&#34;.

It also provides various utils for the &#34;app.py&#34; file, especially to add file download buttons.
&#34;&#34;&#34;


# ----------------------------------------------------------------------------------------------------------------------
# --- Imports

import base64
import os


# ----------------------------------------------------------------------------------------------------------------------
# --- Paths to files that can be downloaded from the simulator

path_to_files = os.path.dirname(os.path.abspath(__file__))
path_to_files = os.path.join(path_to_files, &#39;files&#39;)


# ----------------------------------------------------------------------------------------------------------------------
# --- Utils for the calculator.py file


COUNTRIES_WITH_MINIMUM_REPORTING = [&#39;KOR&#39;, &#39;NLD&#39;, &#39;IRL&#39;, &#39;FIN&#39;]
COUNTRIES_WITH_CONTINENTAL_REPORTING = [&#39;AUT&#39;, &#39;NOR&#39;, &#39;SVN&#39;, &#39;SWE&#39;]


def rename_partner_jurisdictions(row):
    &#34;&#34;&#34;
    In the OECD data, each reporting country displays a line &#34;Foreign Jurisdictions Total&#34;, which displays the sum of
    revenues, profits, corporate income taxes paid, etc. for the parent country across all foreign partner jurisdic-
    tions. In most cases, we want to eliminate this total to avoid any double-counting. But some countries (see list of
    alpha-3 codes above) only display a domestic vs. foreign breakdown and in these cases, it is important that we do
    not erase the &#34;Foreign Jurisdictions Total&#34; line. Therefore, we slightly rename it for these countries.
    &#34;&#34;&#34;

    if row[&#39;Parent jurisdiction (alpha-3 code)&#39;] in COUNTRIES_WITH_MINIMUM_REPORTING:

        if row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;] == &#39;Foreign Jurisdictions Total&#39;:
            return &#39;Foreign Total&#39;

        else:
            return row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;]

    else:
        return row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;]


def manage_overlap_with_domestic(row, kind):
    &#34;&#34;&#34;
    When cleaning and preprocessing the OECD data, we introduce several indicator variables:

    - one that takes value 1 if and only if the partner jurisdiction is a tax haven;
    - another that takes value 1 if and only if the partner jurisdiction is a non-haven country;
    - and a last one that indicates whether the parent and partner jurisdictions coincide.

    In the breakdown of the total tax deficit into domestic, tax-haven-based and non-haven tax deficits, we need to
    avoid any double-counting and two of these indicator variables cannot take the value 1 simultaneously.

    We therefore give the priority to the &#34;Is domestic?&#34; indicator variable: no matter whether the jurisdiction is a tax
    haven or not, this indicator variable takes the value 1 if the parent and partner are the same, while the other in-
    dicator variables are set to 0.
    &#34;&#34;&#34;
    if row[&#39;Is domestic?&#39;]:
        return 0

    else:
        if kind == &#39;haven&#39;:
            return row[&#39;Is partner jurisdiction a tax haven?&#39;]
        elif kind == &#39;non-haven&#39;:
            return row[&#39;Is partner jurisdiction a non-haven?&#39;]


def combine_haven_tax_deficits(row):
    &#34;&#34;&#34;
    This function is used to compute the tax deficit of all in-sample headquarter countries in the multilateral imple-
    mentation scenario.

    For parent countries that are in both the OECD and TWZ data, we have two different sources to compute their tax-
    haven-based tax deficit and we retain the highest of these two amounts.

    Besides, for parent countries in the OECD data that do not report a fully detailed country-by-country breakdown of
    the activity of their multinationals, we cannot distinguish their tax-haven and non-haven tax deficits. Quite arbi-
    trarily in the Python code, we attribute everything to the non-haven tax deficit. In the Table A1 of the report,
    these specific cases are described with the &#34;Only foreign aggregate data&#34; column.
    &#34;&#34;&#34;
    if row[&#39;Parent jurisdiction (alpha-3 code)&#39;] not in (
        COUNTRIES_WITH_MINIMUM_REPORTING + COUNTRIES_WITH_CONTINENTAL_REPORTING
    ):
        return max(row[&#39;tax_deficit_x_tax_haven&#39;], row[&#39;tax_deficit_x_tax_haven_TWZ&#39;])

    else:
        return 0


# ----------------------------------------------------------------------------------------------------------------------
# --- Utils for the firm_level.py file

ADDITIONAL_ETRs = {
    &#39;GEO&#39;: 0.15,
    &#39;BLR&#39;: 0.18,
    &#39;SOM&#39;: 0.05,
    &#39;PNG&#39;: 0.3,
    &#39;TLS&#39;: 0.1,
    &#39;ABW&#39;: 0.25,
    &#39;MOZ&#39;: 0.32,
    &#39;GAB&#39;: 0.3,
    &#39;CRI&#39;: 0.3
}


def compute_ETRs(row, kind):
    &#34;&#34;&#34;
    This function is used in the &#34;firm_level.py&#34; file to determine, for each partner jurisdiction where the multinatio-
    nal is active, what effective tax rate should be used. When we can, we compute the ETR on a cash basis as the ratio
    of the amount of corporate income taxes paid to profit before tax.

    If this computation yields an error (0 profit before tax or NaN value at the numerator or denominator):

    - for non-bank multinationals, we take the statutory corporate income tax rate of the partner jurisdiction;

    - for banks, we take the average ETR faced by the multinational in this jurisdiction over the last 6 years.

    Besides, for banks, if the computed ETR is negative, we replace it by the pre-computed average ETR.
    &#34;&#34;&#34;

    if kind == &#39;mne&#39;:
        # In the case of a non-bank multinational
        if row[&#39;Partner jurisdiction code&#39;] in ADDITIONAL_ETRs.keys():
            return ADDITIONAL_ETRs[row[&#39;Partner jurisdiction code&#39;]]

        else:
            try:
                effective_tax_rate = row[&#39;CIT paid&#39;] / row[&#39;Profit before tax&#39;]

            except:
                # If the usual computation yields an error, we use the statutory corporate tax rate
                effective_tax_rate = row[&#39;Statutory CIT rate&#39;]

            return effective_tax_rate

    elif kind == &#39;bank&#39;:
        # In the case of a bank
        try:
            effective_tax_rate = row[&#39;CIT paid&#39;] / row[&#39;Profit before tax&#39;]

        except:
            # If the usual computation yields an error, we use the average ETR computed over the last 6 years
            effective_tax_rate = row[&#39;Average ETR over 6 years&#39;]

        if effective_tax_rate &lt; 0:
            # If the ETR computed on a cash basis is negative, we replace it with the average ETR
            effective_tax_rate = row[&#39;Average ETR over 6 years&#39;]

        return effective_tax_rate


# ----------------------------------------------------------------------------------------------------------------------
# --- Utils for the app.py file

def get_table_download_button(df, scenario, effective_tax_rate, company=None, taxing_country=None):
    &#34;&#34;&#34;
    This function is used in the &#34;app.py&#34; file to generate the HTML code that instantiates the download button on the
    following pages: &#34;Case study with one multinational&#34; (scenario=0), &#34;Multilateral implementation scenario&#34; (scenario
    =1), &#34;Partial cooperation scenario&#34; (scenario=2) and &#34;Unilateral implementation scenario&#34; (scenario=3).

    The HTML code is then injected in a st.markdown() component, the &#34;allow_unsafe_html&#34; argument being set to True.

    This sort of hack was found on Streamlit user forums.
    &#34;&#34;&#34;

    # We output the DataFrame to a csv format
    csv = df.to_csv(index=False)

    # We encode the csv file in the right format
    b64 = base64.b64encode(csv.encode()).decode()

    href = f&#39;&lt;a href=&#34;data:file/csv;base64,{b64}&#34;&#39;

    if scenario == 0:
        # &#34;Case study with one multinational&#34; page
        company_name = company.lower().replace(&#39; &#39;, &#39;_&#39;)

        href += f&#39; download=&#34;{company_name}_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 1:
        # &#34;Multilateral implementation scenario&#34; page
        href += f&#39; download=&#34;multilateral_scenario_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 2:
        # &#34;Partial cooperation scenario&#34; page
        href += f&#39; download=&#34;partial_cooperation_scenario_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 3:
        # &#34;Unilateral implementation scenario&#34; page
        taxing_country = taxing_country.lower().replace(&#39; &#39;, &#39;_&#39;)

        if &#39;china&#39; in taxing_country:
            taxing_country = &#39;china&#39;

        href += f&#39; download=&#34;unilateral_scenario_{taxing_country}_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    else:
        raise Exception(&#39;Value not accepted for the scenario argument.&#39;)

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the table&#34; class=&#34;download-button table&#34;&gt;&lt;/a&gt;&#39;

    return href


def get_report_download_button():
    &#34;&#34;&#34;
    Following the same principle, this function builds the HTML code that instantiates the download button allowing the
    user to obtain the full-text version of the study in PDF format.
    &#34;&#34;&#34;

    # We fetch and read the .pdf file from the files folder
    path = os.path.join(path_to_files, &#39;EUTO2021.pdf&#39;)

    with open(path, &#39;rb&#39;) as file:
        report_content = file.read()

    # We encode it to the right format
    b64 = base64.b64encode(report_content).decode()

    # And we build the HTML code
    href = f&#39;&lt;a href=&#34;data:application/octet-stream;base64,{b64}&#34; download=&#34;{os.path.basename(path)}&#34;&gt;&#39;

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the full-text report (PDF)&#34; &#39;

    href += &#39;class=&#34;download-button pdf&#34;&gt;&lt;/a&gt;&#39;

    return href


def get_appendix_download_button():
    &#34;&#34;&#34;
    Not yet used but following the same principle, this function builds the HTML code that will ultimately instantiate
    the download button allowing the user to obtain the main and appendix tables of the study in Excel format.
    &#34;&#34;&#34;

    # We fetch and read the .xlsx file from the files folder
    path = os.path.join(path_to_files, &#39;test.xlsx&#39;)

    with open(path, &#39;rb&#39;) as file:
        excel_content = file.read()

    # We encode it in the right format
    b64 = base64.b64encode(excel_content).decode()

    href = f&#39;&lt;a href=&#34;data:application/octet-stream;base64,{b64}&#34; download=&#34;{os.path.basename(path)}&#34;&gt;&#39;

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the appendix tables (Excel)&#34; &#39;

    href += &#39;class=&#34;download-button excel&#34;&gt;&lt;/a&gt;&#39;

    return href</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="tax_deficit_simulator.utils.combine_haven_tax_deficits"><code class="name flex">
<span>def <span class="ident">combine_haven_tax_deficits</span></span>(<span>row)</span>
</code></dt>
<dd>
<div class="desc"><p>This function is used to compute the tax deficit of all in-sample headquarter countries in the multilateral imple-
mentation scenario.</p>
<p>For parent countries that are in both the OECD and TWZ data, we have two different sources to compute their tax-
haven-based tax deficit and we retain the highest of these two amounts.</p>
<p>Besides, for parent countries in the OECD data that do not report a fully detailed country-by-country breakdown of
the activity of their multinationals, we cannot distinguish their tax-haven and non-haven tax deficits. Quite arbi-
trarily in the Python code, we attribute everything to the non-haven tax deficit. In the Table A1 of the report,
these specific cases are described with the "Only foreign aggregate data" column.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def combine_haven_tax_deficits(row):
    &#34;&#34;&#34;
    This function is used to compute the tax deficit of all in-sample headquarter countries in the multilateral imple-
    mentation scenario.

    For parent countries that are in both the OECD and TWZ data, we have two different sources to compute their tax-
    haven-based tax deficit and we retain the highest of these two amounts.

    Besides, for parent countries in the OECD data that do not report a fully detailed country-by-country breakdown of
    the activity of their multinationals, we cannot distinguish their tax-haven and non-haven tax deficits. Quite arbi-
    trarily in the Python code, we attribute everything to the non-haven tax deficit. In the Table A1 of the report,
    these specific cases are described with the &#34;Only foreign aggregate data&#34; column.
    &#34;&#34;&#34;
    if row[&#39;Parent jurisdiction (alpha-3 code)&#39;] not in (
        COUNTRIES_WITH_MINIMUM_REPORTING + COUNTRIES_WITH_CONTINENTAL_REPORTING
    ):
        return max(row[&#39;tax_deficit_x_tax_haven&#39;], row[&#39;tax_deficit_x_tax_haven_TWZ&#39;])

    else:
        return 0</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.compute_ETRs"><code class="name flex">
<span>def <span class="ident">compute_ETRs</span></span>(<span>row, kind)</span>
</code></dt>
<dd>
<div class="desc"><p>This function is used in the "firm_level.py" file to determine, for each partner jurisdiction where the multinatio-
nal is active, what effective tax rate should be used. When we can, we compute the ETR on a cash basis as the ratio
of the amount of corporate income taxes paid to profit before tax.</p>
<p>If this computation yields an error (0 profit before tax or NaN value at the numerator or denominator):</p>
<ul>
<li>
<p>for non-bank multinationals, we take the statutory corporate income tax rate of the partner jurisdiction;</p>
</li>
<li>
<p>for banks, we take the average ETR faced by the multinational in this jurisdiction over the last 6 years.</p>
</li>
</ul>
<p>Besides, for banks, if the computed ETR is negative, we replace it by the pre-computed average ETR.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def compute_ETRs(row, kind):
    &#34;&#34;&#34;
    This function is used in the &#34;firm_level.py&#34; file to determine, for each partner jurisdiction where the multinatio-
    nal is active, what effective tax rate should be used. When we can, we compute the ETR on a cash basis as the ratio
    of the amount of corporate income taxes paid to profit before tax.

    If this computation yields an error (0 profit before tax or NaN value at the numerator or denominator):

    - for non-bank multinationals, we take the statutory corporate income tax rate of the partner jurisdiction;

    - for banks, we take the average ETR faced by the multinational in this jurisdiction over the last 6 years.

    Besides, for banks, if the computed ETR is negative, we replace it by the pre-computed average ETR.
    &#34;&#34;&#34;

    if kind == &#39;mne&#39;:
        # In the case of a non-bank multinational
        if row[&#39;Partner jurisdiction code&#39;] in ADDITIONAL_ETRs.keys():
            return ADDITIONAL_ETRs[row[&#39;Partner jurisdiction code&#39;]]

        else:
            try:
                effective_tax_rate = row[&#39;CIT paid&#39;] / row[&#39;Profit before tax&#39;]

            except:
                # If the usual computation yields an error, we use the statutory corporate tax rate
                effective_tax_rate = row[&#39;Statutory CIT rate&#39;]

            return effective_tax_rate

    elif kind == &#39;bank&#39;:
        # In the case of a bank
        try:
            effective_tax_rate = row[&#39;CIT paid&#39;] / row[&#39;Profit before tax&#39;]

        except:
            # If the usual computation yields an error, we use the average ETR computed over the last 6 years
            effective_tax_rate = row[&#39;Average ETR over 6 years&#39;]

        if effective_tax_rate &lt; 0:
            # If the ETR computed on a cash basis is negative, we replace it with the average ETR
            effective_tax_rate = row[&#39;Average ETR over 6 years&#39;]

        return effective_tax_rate</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.get_appendix_download_button"><code class="name flex">
<span>def <span class="ident">get_appendix_download_button</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Not yet used but following the same principle, this function builds the HTML code that will ultimately instantiate
the download button allowing the user to obtain the main and appendix tables of the study in Excel format.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_appendix_download_button():
    &#34;&#34;&#34;
    Not yet used but following the same principle, this function builds the HTML code that will ultimately instantiate
    the download button allowing the user to obtain the main and appendix tables of the study in Excel format.
    &#34;&#34;&#34;

    # We fetch and read the .xlsx file from the files folder
    path = os.path.join(path_to_files, &#39;test.xlsx&#39;)

    with open(path, &#39;rb&#39;) as file:
        excel_content = file.read()

    # We encode it in the right format
    b64 = base64.b64encode(excel_content).decode()

    href = f&#39;&lt;a href=&#34;data:application/octet-stream;base64,{b64}&#34; download=&#34;{os.path.basename(path)}&#34;&gt;&#39;

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the appendix tables (Excel)&#34; &#39;

    href += &#39;class=&#34;download-button excel&#34;&gt;&lt;/a&gt;&#39;

    return href</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.get_report_download_button"><code class="name flex">
<span>def <span class="ident">get_report_download_button</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Following the same principle, this function builds the HTML code that instantiates the download button allowing the
user to obtain the full-text version of the study in PDF format.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_report_download_button():
    &#34;&#34;&#34;
    Following the same principle, this function builds the HTML code that instantiates the download button allowing the
    user to obtain the full-text version of the study in PDF format.
    &#34;&#34;&#34;

    # We fetch and read the .pdf file from the files folder
    path = os.path.join(path_to_files, &#39;EUTO2021.pdf&#39;)

    with open(path, &#39;rb&#39;) as file:
        report_content = file.read()

    # We encode it to the right format
    b64 = base64.b64encode(report_content).decode()

    # And we build the HTML code
    href = f&#39;&lt;a href=&#34;data:application/octet-stream;base64,{b64}&#34; download=&#34;{os.path.basename(path)}&#34;&gt;&#39;

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the full-text report (PDF)&#34; &#39;

    href += &#39;class=&#34;download-button pdf&#34;&gt;&lt;/a&gt;&#39;

    return href</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.get_table_download_button"><code class="name flex">
<span>def <span class="ident">get_table_download_button</span></span>(<span>df, scenario, effective_tax_rate, company=None, taxing_country=None)</span>
</code></dt>
<dd>
<div class="desc"><p>This function is used in the "app.py" file to generate the HTML code that instantiates the download button on the
following pages: "Case study with one multinational" (scenario=0), "Multilateral implementation scenario" (scenario
=1), "Partial cooperation scenario" (scenario=2) and "Unilateral implementation scenario" (scenario=3).</p>
<p>The HTML code is then injected in a st.markdown() component, the "allow_unsafe_html" argument being set to True.</p>
<p>This sort of hack was found on Streamlit user forums.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_table_download_button(df, scenario, effective_tax_rate, company=None, taxing_country=None):
    &#34;&#34;&#34;
    This function is used in the &#34;app.py&#34; file to generate the HTML code that instantiates the download button on the
    following pages: &#34;Case study with one multinational&#34; (scenario=0), &#34;Multilateral implementation scenario&#34; (scenario
    =1), &#34;Partial cooperation scenario&#34; (scenario=2) and &#34;Unilateral implementation scenario&#34; (scenario=3).

    The HTML code is then injected in a st.markdown() component, the &#34;allow_unsafe_html&#34; argument being set to True.

    This sort of hack was found on Streamlit user forums.
    &#34;&#34;&#34;

    # We output the DataFrame to a csv format
    csv = df.to_csv(index=False)

    # We encode the csv file in the right format
    b64 = base64.b64encode(csv.encode()).decode()

    href = f&#39;&lt;a href=&#34;data:file/csv;base64,{b64}&#34;&#39;

    if scenario == 0:
        # &#34;Case study with one multinational&#34; page
        company_name = company.lower().replace(&#39; &#39;, &#39;_&#39;)

        href += f&#39; download=&#34;{company_name}_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 1:
        # &#34;Multilateral implementation scenario&#34; page
        href += f&#39; download=&#34;multilateral_scenario_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 2:
        # &#34;Partial cooperation scenario&#34; page
        href += f&#39; download=&#34;partial_cooperation_scenario_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    elif scenario == 3:
        # &#34;Unilateral implementation scenario&#34; page
        taxing_country = taxing_country.lower().replace(&#39; &#39;, &#39;_&#39;)

        if &#39;china&#39; in taxing_country:
            taxing_country = &#39;china&#39;

        href += f&#39; download=&#34;unilateral_scenario_{taxing_country}_{effective_tax_rate}_perc.csv&#34;&gt;&#39;

    else:
        raise Exception(&#39;Value not accepted for the scenario argument.&#39;)

    href += &#39;&lt;input type=&#34;button&#34; value=&#34;Click here to download the table&#34; class=&#34;download-button table&#34;&gt;&lt;/a&gt;&#39;

    return href</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.manage_overlap_with_domestic"><code class="name flex">
<span>def <span class="ident">manage_overlap_with_domestic</span></span>(<span>row, kind)</span>
</code></dt>
<dd>
<div class="desc"><p>When cleaning and preprocessing the OECD data, we introduce several indicator variables:</p>
<ul>
<li>one that takes value 1 if and only if the partner jurisdiction is a tax haven;</li>
<li>another that takes value 1 if and only if the partner jurisdiction is a non-haven country;</li>
<li>and a last one that indicates whether the parent and partner jurisdictions coincide.</li>
</ul>
<p>In the breakdown of the total tax deficit into domestic, tax-haven-based and non-haven tax deficits, we need to
avoid any double-counting and two of these indicator variables cannot take the value 1 simultaneously.</p>
<p>We therefore give the priority to the "Is domestic?" indicator variable: no matter whether the jurisdiction is a tax
haven or not, this indicator variable takes the value 1 if the parent and partner are the same, while the other in-
dicator variables are set to 0.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def manage_overlap_with_domestic(row, kind):
    &#34;&#34;&#34;
    When cleaning and preprocessing the OECD data, we introduce several indicator variables:

    - one that takes value 1 if and only if the partner jurisdiction is a tax haven;
    - another that takes value 1 if and only if the partner jurisdiction is a non-haven country;
    - and a last one that indicates whether the parent and partner jurisdictions coincide.

    In the breakdown of the total tax deficit into domestic, tax-haven-based and non-haven tax deficits, we need to
    avoid any double-counting and two of these indicator variables cannot take the value 1 simultaneously.

    We therefore give the priority to the &#34;Is domestic?&#34; indicator variable: no matter whether the jurisdiction is a tax
    haven or not, this indicator variable takes the value 1 if the parent and partner are the same, while the other in-
    dicator variables are set to 0.
    &#34;&#34;&#34;
    if row[&#39;Is domestic?&#39;]:
        return 0

    else:
        if kind == &#39;haven&#39;:
            return row[&#39;Is partner jurisdiction a tax haven?&#39;]
        elif kind == &#39;non-haven&#39;:
            return row[&#39;Is partner jurisdiction a non-haven?&#39;]</code></pre>
</details>
</dd>
<dt id="tax_deficit_simulator.utils.rename_partner_jurisdictions"><code class="name flex">
<span>def <span class="ident">rename_partner_jurisdictions</span></span>(<span>row)</span>
</code></dt>
<dd>
<div class="desc"><p>In the OECD data, each reporting country displays a line "Foreign Jurisdictions Total", which displays the sum of
revenues, profits, corporate income taxes paid, etc. for the parent country across all foreign partner jurisdic-
tions. In most cases, we want to eliminate this total to avoid any double-counting. But some countries (see list of
alpha-3 codes above) only display a domestic vs. foreign breakdown and in these cases, it is important that we do
not erase the "Foreign Jurisdictions Total" line. Therefore, we slightly rename it for these countries.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def rename_partner_jurisdictions(row):
    &#34;&#34;&#34;
    In the OECD data, each reporting country displays a line &#34;Foreign Jurisdictions Total&#34;, which displays the sum of
    revenues, profits, corporate income taxes paid, etc. for the parent country across all foreign partner jurisdic-
    tions. In most cases, we want to eliminate this total to avoid any double-counting. But some countries (see list of
    alpha-3 codes above) only display a domestic vs. foreign breakdown and in these cases, it is important that we do
    not erase the &#34;Foreign Jurisdictions Total&#34; line. Therefore, we slightly rename it for these countries.
    &#34;&#34;&#34;

    if row[&#39;Parent jurisdiction (alpha-3 code)&#39;] in COUNTRIES_WITH_MINIMUM_REPORTING:

        if row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;] == &#39;Foreign Jurisdictions Total&#39;:
            return &#39;Foreign Total&#39;

        else:
            return row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;]

    else:
        return row[&#39;Partner jurisdiction (whitespaces cleaned)&#39;]</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="tax_deficit_simulator" href="index.html">tax_deficit_simulator</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="tax_deficit_simulator.utils.combine_haven_tax_deficits" href="#tax_deficit_simulator.utils.combine_haven_tax_deficits">combine_haven_tax_deficits</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.compute_ETRs" href="#tax_deficit_simulator.utils.compute_ETRs">compute_ETRs</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.get_appendix_download_button" href="#tax_deficit_simulator.utils.get_appendix_download_button">get_appendix_download_button</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.get_report_download_button" href="#tax_deficit_simulator.utils.get_report_download_button">get_report_download_button</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.get_table_download_button" href="#tax_deficit_simulator.utils.get_table_download_button">get_table_download_button</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.manage_overlap_with_domestic" href="#tax_deficit_simulator.utils.manage_overlap_with_domestic">manage_overlap_with_domestic</a></code></li>
<li><code><a title="tax_deficit_simulator.utils.rename_partner_jurisdictions" href="#tax_deficit_simulator.utils.rename_partner_jurisdictions">rename_partner_jurisdictions</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>